{% extends 'base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'style.css' %}">

{% block content %}
<div class="container">
    <!-- Mostrar mensajes de Django -->
    {% if messages %}
        <div class="alert-container">
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Grupo de botones para filtrar notificaciones por prioridad -->
    <div class="btn-group mb-3" role="group" aria-label="Filtrar por prioridad">
        <h3>Clasificar las notificaciones:</h3>
        <div>
            <a href="?prioridad=alta" class="btn btn-danger ml-3 {% if request.GET.prioridad == 'alta' %}active{% endif %}">Alta</a>
            <a href="?prioridad=media" class="btn btn-warning ml-2 {% if request.GET.prioridad == 'media' %}active{% endif %}">Media</a>
            <a href="?prioridad=baja" class="btn btn-secondary ml-2 {% if request.GET.prioridad == 'baja' %}active{% endif %}">Baja</a>
            <a href="?" class="btn btn-primary ml-2 {% if not request.GET.prioridad %}active{% endif %}">Mostrar todas</a>
        </div>
    </div>
   
    <!-- Barra de búsqueda para buscar notificaciones por mensaje -->
    <form method="get" action="">
        <div class="input-group mb-3">
            <input type="text" name="query" value="{{ request.GET.query }}" class="form-control" placeholder="Buscar notificación..." aria-label="Buscar notificación" aria-describedby="button-addon2">
            <div class="input-group-append">
                <button class="btn btn-outline-dark" type="submit" id="button-addon2">Buscar</button>
            </div>
        </div>
    </form>
    
    <h2>Lista de Notificaciones</h2>

    <!-- Formulario para eliminar notificaciones seleccionadas -->
    <form method="post" action="{% url 'notificacion_delete_selected' %}">
        {% csrf_token %}
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col"><input type="checkbox" id="select_all"> Seleccionar</th>
                        <th scope="col">Mensaje</th>
                        <th scope="col">Leído</th>
                        <th scope="col">Fecha de Creación</th>
                        <th scope="col">Tipo de Cambio</th>
                        <th scope="col">Origen</th>
                        <th scope="col">Prioridad</th>
                    </tr>
                </thead>
                <tbody>
                    {% for notificacion in notificaciones %}
                    <tr>
                        <td><input type="checkbox" name="notificaciones" value="{{ notificacion.id }}"></td>
                        <td><a href="{% url 'notificacion_detail' notificacion.pk %}">{{ notificacion.mensaje }}</a></td>
                        <td>{% if notificacion.leido %}Sí{% else %}No{% endif %}</td>
                        <td>{{ notificacion.fecha_creacion }}</td>
                        <td>{{ notificacion.tipo_cambio }}</td>
                        <td>{{ notificacion.origen }}</td>
                        <td>
                            <span class="badge {% if notificacion.prioridad == 'alta' %}badge-danger{% elif notificacion.prioridad == 'media' %}badge-warning{% else %}badge-secondary{% endif %}">
                                {{ notificacion.prioridad }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Dropdown para seleccionar la nueva prioridad de las notificaciones seleccionadas -->
        <div class="form-group">
            <label for="new_priority">Cambiar prioridad a:</label>
            <select name="new_priority" id="new_priority" class="form-control">
                <option value="alta">Alta</option>
                <option value="media">Media</option>
                <option value="baja">Baja</option>
            </select>
        </div>
        <div class="container-fluid">
            <!-- Botones para eliminar notificaciones seleccionadas o cambiar su prioridad -->
            <button type="submit" class="btn btn-dark mr-4" formaction="{% url 'notificacion_delete_selected' %}" onclick="return confirm('¿Estás seguro que desea eliminar?')">Eliminar Seleccionadas</button>
            <button type="submit" class="btn btn-success mr-4" formaction="{% url 'notificacion_change_priority' %}" onclick="return confirm('¿Estás seguro que desea cambiar la prioridad?')">Cambiar Prioridad</button>
            <!-- Botón para generar un reporte PDF de las notificaciones -->
            <a href="{% url 'generar_reporte_pdf' %}" class="btn btn-info">Generar Reporte PDF</a>
        </div>
    </form>
</div>

<!-- Script para seleccionar o deseleccionar todas las notificaciones con un solo checkbox -->
<script>
    document.getElementById('select_all').addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('input[name="notificaciones"]');
        for (var checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    });
</script>
{% endblock %}
